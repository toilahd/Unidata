-- CREATE USER DBA_MANAGER IDENTIFIED BY "123";
-- ALTER USER DBA_MANAGER DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP;
-- GRANT CREATE SESSION TO DBA_MANAGER;
-- GRANT DBA TO DBA_MANAGER;


-- 
-- GRANT CREATE USER, ALTER USER, DROP USER TO DBA_MANAGER;
-- GRANT GRANT ANY PRIVILEGE TO DBA_MANAGER;
-- GRANT GRANT ANY ROLE TO DBA_MANAGER;
-- 
BEGIN 
    FOR tbl IN (
        SELECT table_name FROM (
            SELECT 'DANGKY' AS table_name FROM DUAL UNION ALL
            SELECT 'MOMON' FROM DUAL UNION ALL
            SELECT 'HOCPHAN' FROM DUAL UNION ALL
            SELECT 'SINHVIEN' FROM DUAL UNION ALL
            SELECT 'NHANVIEN' FROM DUAL UNION ALL
            SELECT 'DONVI' FROM DUAL UNION ALL
            SELECT 'ACCOUNT' FROM DUAL
        )
    ) LOOP 
        BEGIN 
            EXECUTE IMMEDIATE 'DROP TABLE ' || tbl.table_name || ' CASCADE CONSTRAINTS';
        EXCEPTION 
            WHEN OTHERS THEN 
                NULL; 
        END;
    END LOOP;
END;
/
--

-- ĐƠN VỊ
CREATE TABLE DONVI (
    MADV VARCHAR2(10) PRIMARY KEY,
    TENDV VARCHAR2(100) NOT NULL,
    LOAIDV VARCHAR2(10) CHECK (LOAIDV IN ('Khoa', 'Phòng')),
    TRGDV VARCHAR2(10)
);

-- NHÂN VIÊN
CREATE TABLE NHANVIEN (
    MANLD VARCHAR2(10) PRIMARY KEY,
    HOTEN VARCHAR2(100) NOT NULL,
    PHAI VARCHAR2(5) CHECK (PHAI IN ('Nam', 'Nữ')),
    NGSINH DATE,
    LUONG NUMBER(10,2) CHECK (LUONG >= 0),
    PHUCAP NUMBER(10,2) CHECK (PHUCAP >= 0),
    DT VARCHAR2(15),
    VAITRO VARCHAR2(20) CHECK (VAITRO IN ('NVCB', 'GV', 'NVPDT', 'NVPKT', 'NVTCHC', 'NVCTSV', 'TRGDV')),
    MADV VARCHAR2(10),
    CONSTRAINT FK_NHANVIEN_DONVI FOREIGN KEY (MADV) REFERENCES DONVI(MADV)
);
ALTER TABLE DONVI 
ADD CONSTRAINT FK_DONVI_NHANVIEN FOREIGN KEY (TRGDV) REFERENCES NHANVIEN(MANLD);
-- ALTER TABLE DONVI DROP CONSTRAINT FK_DONVI_NHANVIEN;

-- SINH VIÊN
CREATE TABLE SINHVIEN (
    MASV VARCHAR2(10) PRIMARY KEY,
    HOTEN VARCHAR2(100) NOT NULL,
    PHAI VARCHAR2(5) CHECK (PHAI IN ('Nam', 'Nữ')),
    NGSINH DATE,
    DCHI VARCHAR2(200),
    DT VARCHAR2(15),
    KHOA VARCHAR2(10),
    TINHTRANG VARCHAR2(20) CHECK (TINHTRANG IN ('Đang học', 'Nghỉ học', 'Bảo lưu')),
    CONSTRAINT FK_SINHVIEN_DONVI FOREIGN KEY (KHOA) REFERENCES DONVI(MADV)
);

-- HỌC PHẦN
CREATE TABLE HOCPHAN (
    MAHP VARCHAR2(10) PRIMARY KEY,
    TENHP VARCHAR2(100) NOT NULL,
    SOTC NUMBER(2) CHECK (SOTC > 0),
    STLT NUMBER(3) CHECK (STLT >= 0),
    STTH NUMBER(3) CHECK (STTH >= 0),
    MADV VARCHAR2(10),
    CONSTRAINT FK_HOCPHAN_DONVI FOREIGN KEY (MADV) REFERENCES DONVI(MADV)
);

-- MỞ MÔN
CREATE TABLE MOMON (
    MAMM VARCHAR2(10) PRIMARY KEY,
    MAHP VARCHAR2(10),
    MAGV VARCHAR2(10),
    HK NUMBER(1) CHECK (HK IN (1, 2, 3)),
    NAM NUMBER(4),
    CONSTRAINT FK_MOMON_HOCPHAN FOREIGN KEY (MAHP) REFERENCES HOCPHAN(MAHP),
    CONSTRAINT FK_MOMON_NHANVIEN FOREIGN KEY (MAGV) REFERENCES NHANVIEN(MANLD)
);

-- ĐĂNG KÝ
CREATE TABLE DANGKY (
    MASV VARCHAR2(10),
    MAMM VARCHAR2(10),
    DIEMTH NUMBER(5,2) CHECK (DIEMTH BETWEEN 0 AND 10),
    DIEMQT NUMBER(5,2) CHECK (DIEMQT BETWEEN 0 AND 10),
    DIEMCK NUMBER(5,2) CHECK (DIEMCK BETWEEN 0 AND 10),
    DIEMTK NUMBER(5,2) CHECK (DIEMTK BETWEEN 0 AND 10),
    CONSTRAINT PK_DANGKY PRIMARY KEY (MASV, MAMM),
    CONSTRAINT FK_DANGKY_SINHVIEN FOREIGN KEY (MASV) REFERENCES SINHVIEN(MASV),
    CONSTRAINT FK_DANGKY_MOMON FOREIGN KEY (MAMM) REFERENCES MOMON(MAMM)
);
-- CHO OLS
CREATE TABLE THONGBAO (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOIDUNG VARCHAR2(1000),
    NGAYGUI DATE DEFAULT SYSDATE,
    OLS_LABEL NUMBER
);
